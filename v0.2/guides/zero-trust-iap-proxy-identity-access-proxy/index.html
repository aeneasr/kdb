<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.61">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-71865250-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="search" type="application/opensearchdescription+xml" title="ORY Kratos" href="/kratos/docs/opensearch.xml"><title data-react-helmet="true">Zero Trust with IAP Proxy | ORY Kratos</title><meta data-react-helmet="true" name="docsearch:version" content="v0.2"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Zero Trust with IAP Proxy | ORY Kratos"><meta data-react-helmet="true" name="description" content="The Quickstart covers a basic set up that uses a pipe in"><meta data-react-helmet="true" property="og:description" content="The Quickstart covers a basic set up that uses a pipe in"><meta data-react-helmet="true" property="og:url" content="https://www.ory.sh//kratos/docs/v0.2/guides/zero-trust-iap-proxy-identity-access-proxy"><link data-react-helmet="true" rel="shortcut icon" href="/kratos/docs/img/favico.png"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="true"><link data-react-helmet="true" rel="canonical" href="https://www.ory.sh//kratos/docs/v0.2/guides/zero-trust-iap-proxy-identity-access-proxy"><link rel="stylesheet" href="/kratos/docs/styles.9e1fc63f.css">
<link rel="preload" href="/kratos/docs/styles.47fe7342.js" as="script">
<link rel="preload" href="/kratos/docs/runtime~main.25132285.js" as="script">
<link rel="preload" href="/kratos/docs/main.ad3de72d.js" as="script">
<link rel="preload" href="/kratos/docs/2.3f0cafd9.js" as="script">
<link rel="preload" href="/kratos/docs/3.9748f2ba.js" as="script">
<link rel="preload" href="/kratos/docs/1be78505.d928f7bc.js" as="script">
<link rel="preload" href="/kratos/docs/eb6fb697.9e49424f.js" as="script">
<link rel="preload" href="/kratos/docs/255.5a2f44ed.js" as="script">
<link rel="preload" href="/kratos/docs/254.7bfb09c2.js" as="script">
<link rel="preload" href="/kratos/docs/589d5674.af1ba59e.js" as="script">
<link rel="preload" href="/kratos/docs/17896441.b979b995.js" as="script">
<link rel="preload" href="/kratos/docs/b700ae95.fcbb9753.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a href="https://www.ory.sh/kratos" target="_blank" rel="noopener noreferrer" class="navbar__brand"><img class="navbar__logo" src="/kratos/docs/img/logo-kratos.svg" alt="ORY Kratos"><strong class="navbar__title"></strong></a><a class="navbar__item navbar__link" href="/kratos/docs/">Docs</a><a href="https://www.ory.sh/docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Ecosystem</a><a href="https://www.ory.sh/blog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog</a><a href="https://community.ory.sh" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Forum</a><a href="https://www.ory.sh/chat" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Chat</a><a href="https://github.com/ory/kratos" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/kratos/docs/versions">v0.4</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span><span class="DocSearch-Button-Key">âŒ˜</span><span class="DocSearch-Button-Key">K</span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a href="https://www.ory.sh/kratos" target="_blank" rel="noopener noreferrer" class="navbar__brand"><img class="navbar__logo" src="/kratos/docs/img/logo-kratos.svg" alt="ORY Kratos"><strong class="navbar__title"></strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/kratos/docs/">Docs</a></li><li class="menu__list-item"><a href="https://www.ory.sh/docs" target="_blank" rel="noopener noreferrer" class="menu__link">Ecosystem</a></li><li class="menu__list-item"><a href="https://www.ory.sh/blog" target="_blank" rel="noopener noreferrer" class="menu__link">Blog</a></li><li class="menu__list-item"><a href="https://community.ory.sh" target="_blank" rel="noopener noreferrer" class="menu__link">Forum</a></li><li class="menu__list-item"><a href="https://www.ory.sh/chat" target="_blank" rel="noopener noreferrer" class="menu__link">Chat</a></li><li class="menu__list-item"><a href="https://github.com/ory/kratos" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a class="menu__link" href="/kratos/docs/versions">v0.4</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Introduction</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/quickstart">Quickstart</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/install">Installation</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Concepts</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/concepts/index">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/concepts/ui-user-interface">User Interface</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/concepts/identity-user-model">Identity Data Model</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Identity Credentials</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/concepts/credentials">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/concepts/credentials/username-email-password">Username / Email &amp; Password</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/concepts/credentials/openid-connect-oidc-oauth2">Social Sign In, OpenID Connect, and OAuth2</a></li></ul></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/concepts/email-sms">Out-of-band communication via E-Mail and SMS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/concepts/federation">Federation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/concepts/security">Threat Models and Security Profiles</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Self Service</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/self-service/index">Before you start reading</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Flows</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/self-service/flows/index">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/self-service/flows/user-login-user-registration">User Login and User Registration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/self-service/flows/user-logout">User Logout</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/self-service/flows/user-settings-profile-management">User Settings and Profile Management</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/self-service/flows/password-reset-account-recovery">Account Recovery</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/self-service/flows/user-facing-errors">User-Facing Errors</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/self-service/flows/verify-email-account-activation">Email and Phone Verification and Account Activation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/self-service/flows/2fa-mfa-multi-factor-authentication">MFA / 2FA</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Strategies</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/self-service/strategies/username-email-password">Username or Email and Password</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/self-service/strategies/openid-connect-social-sign-in-oauth2">Social Sign In with OpenID Connect and OAuth2</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/self-service/strategies/user-settings-profile">User Profile</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Hooks</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/self-service/hooks/index">Hooks</a></li></ul></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Guides</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/kratos/docs/v0.2/guides/zero-trust-iap-proxy-identity-access-proxy">Zero Trust with IAP Proxy</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/v0.2/guides/multi-tenancy-multitenant">Multitenancy</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/v0.2/guides/high-availability-ha">High Availability</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Reference</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/reference/configuration">Configuration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/reference/json-schema-json-paths">JSON Schema and JSON Paths</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/reference/html-forms">HTML Form Parser</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/reference/api">REST API</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Debug &amp; Help</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/debug/csrf">Common Cookie and CSRF Pitfalls</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">SDKs</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/sdk/index">Overview</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Further Reading</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/kratos/docs/v0.2/further-reading/comparison">Comparison</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">ORY Hydra</a><ul class="menu__list"><li class="menu__list-item"><a href="https://www.ory.sh/hydra" target="_blank" rel="noreferrer noopener" class="menu__link" tabindex="-1">Home</a></li><li class="menu__list-item"><a href="https://www.ory.sh/hydra/docs" target="_blank" rel="noreferrer noopener" class="menu__link" tabindex="-1">Docs</a></li><li class="menu__list-item"><a href="https://github.com/ory/hydra" target="_blank" rel="noreferrer noopener" class="menu__link" tabindex="-1">GitHub</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">ORY Oathkeeper</a><ul class="menu__list"><li class="menu__list-item"><a href="https://www.ory.sh/oathkeeper" target="_blank" rel="noreferrer noopener" class="menu__link" tabindex="-1">Home</a></li><li class="menu__list-item"><a href="https://www.ory.sh/oathkeeper/docs" target="_blank" rel="noreferrer noopener" class="menu__link" tabindex="-1">Docs</a></li><li class="menu__list-item"><a href="https://github.com/ory/oathkeeper" target="_blank" rel="noreferrer noopener" class="menu__link" tabindex="-1">GitHub</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">ORY Keto</a><ul class="menu__list"><li class="menu__list-item"><a href="https://www.ory.sh/keto" target="_blank" rel="noreferrer noopener" class="menu__link" tabindex="-1">Home</a></li><li class="menu__list-item"><a href="https://www.ory.sh/keto/docs" target="_blank" rel="noreferrer noopener" class="menu__link" tabindex="-1">Docs</a></li><li class="menu__list-item"><a href="https://github.com/ory/keto" target="_blank" rel="noreferrer noopener" class="menu__link" tabindex="-1">GitHub</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for ORY Kratos <strong>vv0.2</strong>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <strong><a href="/kratos/docs/guides/zero-trust-iap-proxy-identity-access-proxy">latest version</a></strong> (v0.4).</div></div><div class="docItemContainer_3QWW"><article><div><span class="badge badge--secondary">Version: v0.2</span></div><header><h1 class="docTitle_1Lrw">Zero Trust with IAP Proxy</h1></header><div class="markdown"><p>The <a href="/kratos/docs/v0.2/quickstart">Quickstart</a> covers a basic set up that uses a pipe in
SecureApp to forward requests to ORY Kratos.</p><p>Systems that have more than a few components often use Reverse Proxies such as
Nginx, Envoy, Kong to route and authorize traffic to applications. ORY Kratos
works very well in such a environment and the purpose of this guide is
clarifying how one can use a reverse proxy with IAP (Identity and Access Proxy)
capabilities to authorize incoming requests. In this tutorial, we will use ORY
Oathkeeper to achieve this.</p><p>This guide expects that you have familiarized yourself with ORY Kratos&#x27; concepts
and that builds on the components and flows established in the
<a href="/kratos/docs/v0.2/quickstart">Quickstart</a>.</p><p>To ensure that no one can access the dashboard without prior authentication
(login), we will use a reverse proxy
(<a href="https://github.com/ory/oathkeeper" target="_blank" rel="noopener noreferrer">ORY Oathkeeper</a>) to deny all
unauthenticated traffic to <code>http://secure-app/dashboard</code> and redirect the user
to the login page at <code>http://secure-app/auth/login</code>. Further, we will configure
access to <code>http://secure-app/auth/login</code> in such a way that access only works if
one is not yet authenticated.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="running-ory-kratos-and-the-ory-oathkeeper-identity-and-access-proxy"></a>Running ORY Kratos and the ORY Oathkeeper Identity and Access Proxy<a aria-hidden="true" tabindex="-1" class="hash-link" href="#running-ory-kratos-and-the-ory-oathkeeper-identity-and-access-proxy" title="Direct link to heading">#</a></h2><p>Clone the ORY Kratos repository and fetch the latest images:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-shell codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> clone https://github.com/ory/kratos.git</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># or if you have git+ssh set up:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#  git clone git@github.com:ory/kratos.git</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> kratos</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> checkout v0.2.1-alpha.1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">docker pull oryd/kratos:latest-sqlite</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">docker pull oryd/kratos-selfservice-ui-node:latest</span></div></div></div></div></div><p>Next, run the quickstart and add the ORY Oathkeeper config:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-shell codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">docker-compose </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -f quickstart.yml </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -f quickstart-oathkeeper.yml </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  up --build --force-recreate</span></div></div></div></div></div><p>This might take a minute or two. Once the output slows down and logs indicate a
healthy system you&#x27;re ready to roll! A healthy system will show something along
the lines of (the order of messages might be reversed):</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kratos_1                      | time=&quot;2020-01-20T14:52:13Z&quot; level=info msg=&quot;Starting the admin httpd on: 0.0.0.0:4434&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kratos_1                      | time=&quot;2020-01-20T14:52:13Z&quot; level=info msg=&quot;Starting the public httpd on: 0.0.0.0:4433&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">oathkeeper_1                  | {&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;TLS has not been configured for api, skipping&quot;,&quot;time&quot;:&quot;2020-01-20T09:22:09Z&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">oathkeeper_1                  | {&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;Listening on http://:4456&quot;,&quot;time&quot;:&quot;2020-01-20T09:22:09Z&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">oathkeeper_1                  | {&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;TLS has not been configured for proxy, skipping&quot;,&quot;time&quot;:&quot;2020-01-20T09:22:09Z&quot;}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">oathkeeper_1                  | {&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;Listening on http://:4455&quot;,&quot;time&quot;:&quot;2020-01-20T09:22:09Z&quot;}</span></div></div></div></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>There are two important factors to get a fully functional system:</h5></div><div class="admonition-content"><ul><li>You need to make sure that ports <code>4435</code>, <code>4455</code>, <code>4456</code>, <code>4433</code>, <code>4434</code>,
<code>4436</code> &gt;
<a href="https://serverfault.com/questions/309052/check-if-port-is-open-or-closed-on-a-linux-server" target="_blank" rel="noopener noreferrer">are free</a>.</li><li>Make sure to always use <code>127.0.0.1</code> as the hostname, never use <code>localhost</code>!
This is important because browsers treat these two as separate domains and
will therefore have issues with setting and using the right cookies.</li></ul></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="network-architecture"></a>Network Architecture<a aria-hidden="true" tabindex="-1" class="hash-link" href="#network-architecture" title="Direct link to heading">#</a></h3><p>This demo makes use of several services / Docker Images:</p><ol><li><a href="https://github.com/ory/kratos" target="_blank" rel="noopener noreferrer">ORY Kratos</a></li><li>The <strong>SecureApp</strong> - an
<a href="http://github.com/ory/kratos-selfservice-ui-node" target="_blank" rel="noopener noreferrer">example application written in NodeJS</a>
that implements the login, registration, logout, ..., and dashboard screen.</li><li>A reverse proxy (<a href="https://github.com/ory/oathkeeper" target="_blank" rel="noopener noreferrer">ORY Oathkeeper</a>) to
protect the <strong>SecureApp</strong>.</li><li>An SMTP server with which ORY Kratos can send E-Mails with. We will use
<a href="https://github.com/mailhog/MailHog" target="_blank" rel="noopener noreferrer">MailHog</a>, a minimalistic SMTP throaway
server with an easy UI.</li></ol><p>To better understand how everything is wired, let&#x27;s take a look at the network
configuration. This assumes that you have at least some understanding of how
Docker (Compose) Networks work:</p><p><a href="https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoiZ3JhcGggVERcblxuc3ViZ3JhcGggaG5bSG9zdCBOZXR3b3JrXVxuICAgIEJbQnJvd3Nlcl1cbiAgICBCLS0-fENhbiBhY2Nlc3MgVVJMcyB2aWEgMTI3LjAuMC4xOjQ0NTV8T0tQSE5cbiAgICBCLS0-fENhbiBhY2Nlc3MgVUkgdmlhIDEyNy4wLjAuMTo0NDM2fFNNVFBVSVxuICAgIE9LUEhOKFtSZXZlcnNlIFByb3h5IGV4cG9zZWQgYXQgOjQ0NTVdKVxuICAgIFNNVFBVSShbTWFpbFNsdXJwZXIgVUkgZXhwb3NlZCBhdCA6NDQzNl0pXG5lbmRcblxuc3ViZ3JhcGggZG5bXCJJbnRlcm5hbCBEb2NrZXIgTmV0d29yayAoaW50cmFuZXQpXCJdXG4gICAgT0tQSE4tLT5PT1xuICAgIFNNVFBVSS0tPlNNVFBcbiAgICBPTy0tPnxQcm94aWVzIFVSTHNzIC8ub3J5L2tyYXRvcy9wdWJsaWMvKiB0b3xPS1xuICAgIE9PLS0-fFwiUHJveGllcyAvYXV0aC9sb2dpbiwgL2F1dGgvcmVnaXN0cmF0aW9uLCAvZGFzaGJvYXJkLCAuLi4gdG9cInxTQVxuICAgIFNBLS0-fFRhbGtzIHRvfE9LXG4gICAgT0stLT58U2VuZHMgbWFpbCB2aWF8U01UUFxuICAgIE9PLS0-fFZhbGlkYXRlcyBhdXRoIHNlc3Npb25zIHVzaW5nfE9LXG5cbiAgICBPS1tPUlkgS3JhdG9zXVxuICAgIE9PW1wiUmV2ZXJzZSBQcm94eSAoT1JZIE9hdGhrZWVwZXIpXCJdXG4gICAgU0FbXCJTZWN1cmVBcHAgKE9SWSBLcmF0b3MgU2VsZlNlcnZpY2UgVUkgTm9kZSBFeGFtcGxlKVwiXVxuICAgIFNNVFBbXCJTTVRQIFNlcnZlciAoTWFpbFNsdXJwZXIpXCJdXG5lbmRcbiIsIm1lcm1haWQiOnsidGhlbWUiOiJuZXV0cmFsIiwiZmxvd2NoYXJ0Ijp7InJhbmtTcGFjaW5nIjo2NSwibm9kZVNwYWNpbmciOjMwLCJjdXJ2ZSI6ImJhc2lzIn19fQ" target="_blank" rel="noopener noreferrer"><img src="https://mermaid.ink/img/eyJjb2RlIjoiZ3JhcGggVERcblxuc3ViZ3JhcGggaG5bSG9zdCBOZXR3b3JrXVxuICAgIEJbQnJvd3Nlcl1cbiAgICBCLS0-fENhbiBhY2Nlc3MgVVJMcyB2aWEgMTI3LjAuMC4xOjQ0NTV8T0tQSE5cbiAgICBCLS0-fENhbiBhY2Nlc3MgVUkgdmlhIDEyNy4wLjAuMTo0NDM2fFNNVFBVSVxuICAgIE9LUEhOKFtSZXZlcnNlIFByb3h5IGV4cG9zZWQgYXQgOjQ0NTVdKVxuICAgIFNNVFBVSShbTWFpbFNsdXJwZXIgVUkgZXhwb3NlZCBhdCA6NDQzNl0pXG5lbmRcblxuc3ViZ3JhcGggZG5bXCJJbnRlcm5hbCBEb2NrZXIgTmV0d29yayAoaW50cmFuZXQpXCJdXG4gICAgT0tQSE4tLT5PT1xuICAgIFNNVFBVSS0tPlNNVFBcbiAgICBPTy0tPnxQcm94aWVzIFVSTHNzIC8ub3J5L2tyYXRvcy9wdWJsaWMvKiB0b3xPS1xuICAgIE9PLS0-fFwiUHJveGllcyAvYXV0aC9sb2dpbiwgL2F1dGgvcmVnaXN0cmF0aW9uLCAvZGFzaGJvYXJkLCAuLi4gdG9cInxTQVxuICAgIFNBLS0-fFRhbGtzIHRvfE9LXG4gICAgT0stLT58U2VuZHMgbWFpbCB2aWF8U01UUFxuICAgIE9PLS0-fFZhbGlkYXRlcyBhdXRoIHNlc3Npb25zIHVzaW5nfE9LXG5cbiAgICBPS1tPUlkgS3JhdG9zXVxuICAgIE9PW1wiUmV2ZXJzZSBQcm94eSAoT1JZIE9hdGhrZWVwZXIpXCJdXG4gICAgU0FbXCJTZWN1cmVBcHAgKE9SWSBLcmF0b3MgU2VsZlNlcnZpY2UgVUkgTm9kZSBFeGFtcGxlKVwiXVxuICAgIFNNVFBbXCJTTVRQIFNlcnZlciAoTWFpbFNsdXJwZXIpXCJdXG5lbmRcbiIsIm1lcm1haWQiOnsidGhlbWUiOiJuZXV0cmFsIiwiZmxvd2NoYXJ0Ijp7InJhbmtTcGFjaW5nIjo2NSwibm9kZVNwYWNpbmciOjMwLCJjdXJ2ZSI6ImJhc2lzIn19fQ" alt="User Login and Registration Network Topology"></a></p><p>As you can see, most requests are proxied through the Reverse Proxy
(<a href="https://github.com/ory/oathkeeper" target="_blank" rel="noopener noreferrer">ORY Oathkeeper</a>). The <code>quickstart.yml</code> file
also defines additional ports such as <code>4434</code>, <code>4456</code>, and others. These ports
are only there for debugging and playing around with and are not actually
required for the demo to work.</p><p>The next diagram shows how we&#x27;ve configured the routes in our Reverse Proxy
(<a href="https://github.com/ory/oathkeeper" target="_blank" rel="noopener noreferrer">ORY Oathkeeper</a>):</p><p><a href="https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoiZ3JhcGggVERcblxuc3ViZ3JhcGggcGlbUHVibGljIEludGVybmV0XVxuICAgIEJbQnJvd3Nlcl1cbmVuZFxuXG5zdWJncmFwaCB2cGNbVlBDIC8gQ2xvdWQgLyBEb2NrZXIgTmV0d29ya11cbnN1YmdyYXBoIFwiRGVtaWxpdGFyaXplZCBab25lIC8gRE1aXCJcbiAgICBPS1tPUlkgT2F0aGtlZXBlciA6NDQ1NV1cbiAgICBCIC0tPiBPS1xuZW5kXG5cbiAgICBPSyAtLT58XCJGb3J3YXJkcyB7LywvZGFzaGJvYXJkfSB0b1wifCBTQURcbiAgICBPSyAtLT58XCJGb3J3YXJkcyAvYXV0aC9sb2dvdXQgdG9cInwgU0FMVVxuICAgIE9LIC0tPnxcIkZvcndhcmRzIC9hdXRoL2xvZ2luIHRvXCJ8IFNBTElcbiAgICBPSyAtLT58XCJGb3J3YXJkcyAvYXV0aC9yZWdpc3RyYXRpb24gdG9cInwgU0FSXG4gICAgT0sgLS0-fFwiRm9yd2FyZHMgL2F1dGgvKiB0b1wifCBTQUFcbiAgICBPSyAtLT58XCJGb3J3YXJkcyAvLm9yeS9rcmF0b3MvcHVibGljLyogdG9cInwgS1BcblxuICAgIHN1YmdyYXBoIFwiUHJpdmF0ZSBTdWJuZXQgLyBJbnRyYW5ldFwiXG4gICAgS1sgT1JZIEtyYXRvcyBdXG5cbiAgICBLUChbIE9SWSBLcmF0b3MgUHVibGljIEFQSSBdKVxuICAgIEtBKFsgT1JZIEtyYXRvcyBBZG1pbiBBUEkgXSlcbiAgICBTQSAtLT4gS0FcbiAgICBLQSAtLmJlbG9uZ3MgdG8uLT4gS1xuICAgIEtQIC0uYmVsb25ncyB0by4tPiBLXG5cbiAgICBzdWJncmFwaCBzYVtcIlNlY3VyZUFwcCAvIGtyYXRvcy1zZXJsZnNlcnZpY2UtdWktbm9kZSBFeGFtcGxlXCJdXG5cbiAgICAgICAgU0FbU2VjdXJlQXBwXVxuICAgICAgICBTQUQgLS5iZWxvbmdzIHRvLi0-IFNBXG4gICAgICAgIFNBTFUgLS5iZWxvbmdzIHRvLi0-IFNBXG4gICAgICAgIFNBTEkgLS5iZWxvbmdzIHRvLi0-IFNBXG4gICAgICAgIFNBUiAtLmJlbG9uZ3MgdG8uLT4gU0FcbiAgICAgICAgU0FBIC0uYmVsb25ncyB0by4tPiBTQVxuXG4gICAgICAgIHN1YmdyYXBoIFwiSGFzIGFjdGl2ZSBsb2dpbiBzZXNzaW9uXCJcbiAgICAgICAgICAgIFNBRChbUm91dGUgL2Rhc2hib2FyZF0pXG4gICAgICAgICAgICBTQUxVKFtSb3V0ZSAvYXV0aC9sb2dvdXRdKVxuICAgICAgICBlbmRcblxuICAgICAgICBzdWJncmFwaCBcIk5vIGFjdGl2ZSBsb2dpbiBzZXNzaW9uXCJcbiAgICAgICAgICAgIFNBTEkoW1JvdXRlIC9hdXRoL2xvZ2luXSkgXG4gICAgICAgICAgICBTQVIoW1JvdXRlIC9hdXRoL3JlZ2lzdHJhdGlvbl0pIFxuICAgICAgICAgICAgU0FBKFtSb3V0ZSAvYXV0aC8uLi5dKVxuICAgICAgICBlbmRcbiAgICBlbmRcbiAgICBlbmRcblxuZW5kXG4iLCJtZXJtYWlkIjp7InRoZW1lIjoibmV1dHJhbCIsImZsb3djaGFydCI6eyJyYW5rU3BhY2luZyI6NzAsIm5vZGVTcGFjaW5nIjozMCwiY3VydmUiOiJiYXNpcyJ9fX0" target="_blank" rel="noopener noreferrer"><img src="https://mermaid.ink/img/eyJjb2RlIjoiZ3JhcGggVERcblxuc3ViZ3JhcGggcGlbUHVibGljIEludGVybmV0XVxuICAgIEJbQnJvd3Nlcl1cbmVuZFxuXG5zdWJncmFwaCB2cGNbVlBDIC8gQ2xvdWQgLyBEb2NrZXIgTmV0d29ya11cbnN1YmdyYXBoIFwiRGVtaWxpdGFyaXplZCBab25lIC8gRE1aXCJcbiAgICBPS1tPUlkgT2F0aGtlZXBlciA6NDQ1NV1cbiAgICBCIC0tPiBPS1xuZW5kXG5cbiAgICBPSyAtLT58XCJGb3J3YXJkcyB7LywvZGFzaGJvYXJkfSB0b1wifCBTQURcbiAgICBPSyAtLT58XCJGb3J3YXJkcyAvYXV0aC9sb2dvdXQgdG9cInwgU0FMVVxuICAgIE9LIC0tPnxcIkZvcndhcmRzIC9hdXRoL2xvZ2luIHRvXCJ8IFNBTElcbiAgICBPSyAtLT58XCJGb3J3YXJkcyAvYXV0aC9yZWdpc3RyYXRpb24gdG9cInwgU0FSXG4gICAgT0sgLS0-fFwiRm9yd2FyZHMgL2F1dGgvKiB0b1wifCBTQUFcbiAgICBPSyAtLT58XCJGb3J3YXJkcyAvLm9yeS9rcmF0b3MvcHVibGljLyogdG9cInwgS1BcblxuICAgIHN1YmdyYXBoIFwiUHJpdmF0ZSBTdWJuZXQgLyBJbnRyYW5ldFwiXG4gICAgS1sgT1JZIEtyYXRvcyBdXG5cbiAgICBLUChbIE9SWSBLcmF0b3MgUHVibGljIEFQSSBdKVxuICAgIEtBKFsgT1JZIEtyYXRvcyBBZG1pbiBBUEkgXSlcbiAgICBTQSAtLT4gS0FcbiAgICBLQSAtLmJlbG9uZ3MgdG8uLT4gS1xuICAgIEtQIC0uYmVsb25ncyB0by4tPiBLXG5cbiAgICBzdWJncmFwaCBzYVtcIlNlY3VyZUFwcCAvIGtyYXRvcy1zZXJsZnNlcnZpY2UtdWktbm9kZSBFeGFtcGxlXCJdXG5cbiAgICAgICAgU0FbU2VjdXJlQXBwXVxuICAgICAgICBTQUQgLS5iZWxvbmdzIHRvLi0-IFNBXG4gICAgICAgIFNBTFUgLS5iZWxvbmdzIHRvLi0-IFNBXG4gICAgICAgIFNBTEkgLS5iZWxvbmdzIHRvLi0-IFNBXG4gICAgICAgIFNBUiAtLmJlbG9uZ3MgdG8uLT4gU0FcbiAgICAgICAgU0FBIC0uYmVsb25ncyB0by4tPiBTQVxuXG4gICAgICAgIHN1YmdyYXBoIFwiSGFzIGFjdGl2ZSBsb2dpbiBzZXNzaW9uXCJcbiAgICAgICAgICAgIFNBRChbUm91dGUgL2Rhc2hib2FyZF0pXG4gICAgICAgICAgICBTQUxVKFtSb3V0ZSAvYXV0aC9sb2dvdXRdKVxuICAgICAgICBlbmRcblxuICAgICAgICBzdWJncmFwaCBcIk5vIGFjdGl2ZSBsb2dpbiBzZXNzaW9uXCJcbiAgICAgICAgICAgIFNBTEkoW1JvdXRlIC9hdXRoL2xvZ2luXSkgXG4gICAgICAgICAgICBTQVIoW1JvdXRlIC9hdXRoL3JlZ2lzdHJhdGlvbl0pIFxuICAgICAgICAgICAgU0FBKFtSb3V0ZSAvYXV0aC8uLi5dKVxuICAgICAgICBlbmRcbiAgICBlbmRcbiAgICBlbmRcblxuZW5kXG4iLCJtZXJtYWlkIjp7InRoZW1lIjoibmV1dHJhbCIsImZsb3djaGFydCI6eyJyYW5rU3BhY2luZyI6NzAsIm5vZGVTcGFjaW5nIjozMCwiY3VydmUiOiJiYXNpcyJ9fX0" alt="User Login and Registration Routes"></a></p><p>You might notice that we&#x27;re also proxying requests to ORY Kratos&#x27; Public API. We
are doing this because that way all requests are going to and coming from the
same hostname. This avoids common cross-domain issues with cookies.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="perform-registration-logout-login"></a>Perform registration, logout, login<a aria-hidden="true" tabindex="-1" class="hash-link" href="#perform-registration-logout-login" title="Direct link to heading">#</a></h2><p>Enough theory, it&#x27;s time to get this thing going! Let&#x27;s start by trying to open
the dashboard - <strong>go to
<a href="http://127.0.0.1:4455/dashboard" target="_blank" rel="noopener noreferrer">127.0.0.1:4455/dashboard</a></strong>.</p><p>Check the <a href="/kratos/docs/v0.2/quickstart">Quickstart</a> for the other flows!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="configuration"></a>Configuration<a aria-hidden="true" tabindex="-1" class="hash-link" href="#configuration" title="Direct link to heading">#</a></h2><p>You can find all configuration files for this quickstart guide in
<code>./contrib/quickstart</code>, <code>./quickstart.yml</code>, <code>./quickstart-oathkeeper.yml</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="ory-oathkeeper-identity-and-access-proxy"></a>ORY Oathkeeper: Identity and Access Proxy<a aria-hidden="true" tabindex="-1" class="hash-link" href="#ory-oathkeeper-identity-and-access-proxy" title="Direct link to heading">#</a></h3><p>All configuration for <a href="https://www.ory.sh/oathkeeper/" target="_blank" rel="noopener noreferrer">ORY Oathkeeper</a> resides
in <code>./contrib/quickstart/oathkeeper</code>.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="configuration-1"></a>Configuration<a aria-hidden="true" tabindex="-1" class="hash-link" href="#configuration-1" title="Direct link to heading">#</a></h4><p>We define several configuration options for ORY Oathkeeper, such as the port
where the proxy should run or where to load the access rules from.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="cookie-session-authenticator"></a>Cookie Session Authenticator<a aria-hidden="true" tabindex="-1" class="hash-link" href="#cookie-session-authenticator" title="Direct link to heading">#</a></h5><p>The
<a href="https://www.ory.sh/docs/oathkeeper/pipeline/authn#cookie_session" target="_blank" rel="noopener noreferrer">Cookie Session Authenticator</a>
is enabled and points to
<a href="/kratos/docs/v0.2/reference/api">ORY Kratos&#x27; <code>/sessions/whoami</code> API</a>. It uses the
<code>ory_kratos_session</code> cookie to identify if a request contains a session or not:</p><div class="mdxCodeBlock_1XEh"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_3nn1">contrib/quickstart/oathkeeper/.oathkeeper.yml</div><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd undefined">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC codeBlockWithTitle_3QsD"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">authenticators</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">cookie_session</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">config</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">check_session_url</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">//kratos</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">4433/sessions/whoami</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">preserve_path</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">extra_from</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;@this&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">subject_from</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;identity.id&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">only</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> ory_kratos_session</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ...</span></div></div></div></div></div><p>It&#x27;s more or less doing what the <code>needsLogin</code> function does in the
<a href="/kratos/docs/v0.2/quickstart">Quickstart</a>.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="anonymous-authenticator"></a>Anonymous Authenticator<a aria-hidden="true" tabindex="-1" class="hash-link" href="#anonymous-authenticator" title="Direct link to heading">#</a></h4><p>The
<a href="https://www.ory.sh/docs/oathkeeper/pipeline/authn#anonymous" target="_blank" rel="noopener noreferrer">Anonymous Authenticator</a>
is useful for endpoints that do not need login, such as the registration screen:</p><div class="mdxCodeBlock_1XEh"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_3nn1">contrib/quickstart/oathkeeper/.oathkeeper.yml</div><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd undefined">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC codeBlockWithTitle_3QsD"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">authenticators</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">anonymous</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">config</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">subject</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> guest</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ...</span></div></div></div></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="allowed-authorizer"></a>Allowed Authorizer<a aria-hidden="true" tabindex="-1" class="hash-link" href="#allowed-authorizer" title="Direct link to heading">#</a></h4><p>The
<a href="https://www.ory.sh/docs/oathkeeper/pipeline/authz#allowed" target="_blank" rel="noopener noreferrer">Allowed Authenticator</a>
simply allows all users to access the URL. Since we don&#x27;t have RBAC or ACL in
place for this example, this will be enough.</p><div class="mdxCodeBlock_1XEh"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_3nn1">contrib/quickstart/oathkeeper/.oathkeeper.yml</div><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd undefined">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC codeBlockWithTitle_3QsD"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">authorizers</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">allowed</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ...</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="id-token-mutator"></a>ID Token Mutator<a aria-hidden="true" tabindex="-1" class="hash-link" href="#id-token-mutator" title="Direct link to heading">#</a></h3><p>The
<a href="https://www.ory.sh/docs/oathkeeper/pipeline/mutator#id_token" target="_blank" rel="noopener noreferrer">ID Token Mutator</a>
takes all the available session information and puts it into a JSON Web Token
(JWT). The protected SecureApp will now receive <code>Authorization: bearer &lt;jwt...&gt;</code>
in the HTTP Header instead of <code>Cookie: ory_kratos_session=...</code>. The JWT is
signed using a RS256 key. To verify the JWT we can use the public key provided
by ORY Oathkeeper&#x27;s JWKS API <code>http://127.0.0.1:4456/.well-known/jwks.json</code>. You
can generate the RS256 key yourself by running:
<code>oathkeeper credentials generate --alg RS256 &gt; id_token.jwks.json</code>.</p><p>We also enabled the
<a href="https://www.ory.sh/docs/oathkeeper/pipeline/mutator#" target="_blank" rel="noopener noreferrer">NoOp Mutator</a> for the
login, registration, ... endpoints:</p><div class="mdxCodeBlock_1XEh"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_3nn1">contrib/quickstart/oathkeeper/.oathkeeper.yml</div><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd undefined">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC codeBlockWithTitle_3QsD"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">mutators</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">noop</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">id_token</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">config</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">issuer_url</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">//127.0.0.1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">4455/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">jwks_url</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> file</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">///etc/config/oathkeeper/id_token.jwks.json</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">claims</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">|</span><span class="token scalar string" style="color:rgb(195, 232, 141)"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">        {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">          &quot;session&quot;: {{ .Extra | toJson }}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token scalar string" style="color:rgb(195, 232, 141)">        }</span></div></div></div></div></div><p>You could obviously also use other mutators such as the
<a href="https://www.ory.sh/docs/oathkeeper/pipeline/mutator#header" target="_blank" rel="noopener noreferrer">Header Mutator</a> and
use headers such as <code>X-User-ID</code> instead of the JWT.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="error-handling"></a>Error Handling<a aria-hidden="true" tabindex="-1" class="hash-link" href="#error-handling" title="Direct link to heading">#</a></h3><p>We configure the error handling in such a way that a missing or invalid login
session (when accessed from a browser) leads to a redirect to <code>/auth/login</code>:</p><div class="mdxCodeBlock_1XEh"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_3nn1">contrib/quickstart/oathkeeper/.oathkeeper.yml</div><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd undefined">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC codeBlockWithTitle_3QsD"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">errors</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">fallback</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> json</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">handlers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">redirect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">config</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">to</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">//127.0.0.1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">4455/auth/login</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">when</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">error</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> unauthorized</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> forbidden</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token key atrule">request</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              </span><span class="token key atrule">header</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                </span><span class="token key atrule">accept</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># We don&#x27;t want this for application/json requests, only browser requests!</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> text/html</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">json</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">enabled</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">config</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">verbose</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="access-rules"></a>Access Rules<a aria-hidden="true" tabindex="-1" class="hash-link" href="#access-rules" title="Direct link to heading">#</a></h3><p>We use <a href="https://github.com/gobwas/glob" target="_blank" rel="noopener noreferrer">glob matching</a> to match the HTTP
requests for our access rules:</p><div class="mdxCodeBlock_1XEh"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_3nn1">contrib/quickstart/oathkeeper/.oathkeeper.yml</div><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd undefined">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC codeBlockWithTitle_3QsD"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">access_rules</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">matching_strategy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> glob</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">repositories</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> file</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">///etc/config/oathkeeper/`access</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">rules.yml`</span></div></div></div></div></div><p>In <code>access-rules.yml</code> we define three rules. The first rule forwards all traffic
matching <code>http://127.0.0.1:4455/.ory/kratos/public/</code> to ORY Kratos&#x27; Public API:</p><div class="mdxCodeBlock_1XEh"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_3nn1">contrib/quickstart/oathkeeper/access-rules.yml</div><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd undefined">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC codeBlockWithTitle_3QsD"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;ory:kratos:public&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">upstream</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">preserve_host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">url</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;http://kratos:4433&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">strip_path</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> /.ory/kratos/public</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">match</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">url</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;http://127.0.0.1:4455/.ory/kratos/public/&lt;**&gt;&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">methods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> GET</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> POST</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> PUT</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> DELETE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> PATCH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">authenticators</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">handler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> noop</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">authorizer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">handler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> allow</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">mutators</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">handler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> noop</span></div></div></div></div></div><p>The second rule allows anonymous requests to login, registration, re-send
verification email, and the error page plus any assets:</p><div class="mdxCodeBlock_1XEh"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_3nn1">contrib/quickstart/oathkeeper/access-rules.yml</div><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd undefined">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC codeBlockWithTitle_3QsD"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;ory:kratos-selfservice-ui-node:anonymous&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">upstream</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">preserve_host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">url</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;http://kratos-selfservice-ui-node:4435&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">match</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">url</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;http://127.0.0.1:4455/&lt;{error,verify,auth/*,**.css,**.js}{/,}&gt;&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">methods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> GET</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">authenticators</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">handler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> anonymous</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">authorizer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">handler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> allow</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">mutators</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">handler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> noop</span></div></div></div></div></div><p>And the final rule requires a valid session before allowing requests to the
dashboard and user settings:</p><div class="mdxCodeBlock_1XEh"><div style="color:#bfc7d5;background-color:#292d3e" class="codeBlockTitle_3nn1">contrib/quickstart/oathkeeper/access-rules.yml</div><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd undefined">Copy</button><div tabindex="0" class="prism-code language-yaml codeBlock_3iAC codeBlockWithTitle_3QsD"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># ...</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;ory:kratos-selfservice-ui-node:protected&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">upstream</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">preserve_host</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token boolean important" style="color:rgb(255, 88, 116)">true</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">url</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;http://kratos-selfservice-ui-node:4435&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">match</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">url</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;http://127.0.0.1:4455/&lt;{,debug,dashboard,settings}{/,}&gt;&#x27;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">methods</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> GET</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">authenticators</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">handler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> cookie_session</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">authorizer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">handler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> allow</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">mutators</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">handler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> id_token</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">errors</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">handler</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> redirect</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">config</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">to</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">//127.0.0.1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">4455/auth/login</span></div></div></div></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="cleaning-up-docker"></a>Cleaning up Docker<a aria-hidden="true" tabindex="-1" class="hash-link" href="#cleaning-up-docker" title="Direct link to heading">#</a></h2><p>To clean everything up, you need to bring down the Docker Compose environment
and remove all mounted volumes.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-shell codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">docker-compose -f quickstart.yml -f quickstart-oathkeeper.yml down -v</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">docker-compose -f quickstart.yml -f quickstart-oathkeeper.yml </span><span class="token function" style="color:rgb(130, 170, 255)">rm</span><span class="token plain"> -f -s -v</span></div></div></div></div></div></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/ory/kratos/edit/master/docs/versioned_docs/version-v0.2/guides/zero-trust-iap-proxy-identity-access-proxy.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2020-06-05T14:36:38.000Z" class="docLastUpdatedAt_217_">6/5/2020</time> by <strong>Bengt Hagemeister</strong></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/kratos/docs/v0.2/self-service/hooks/index"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Hooks</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/kratos/docs/v0.2/guides/multi-tenancy-multitenant"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Multitenancy Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3klQ"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#running-ory-kratos-and-the-ory-oathkeeper-identity-and-access-proxy" class="table-of-contents__link">Running ORY Kratos and the ORY Oathkeeper Identity and Access Proxy</a><ul><li><a href="#network-architecture" class="table-of-contents__link">Network Architecture</a></li></ul></li><li><a href="#perform-registration-logout-login" class="table-of-contents__link">Perform registration, logout, login</a></li><li><a href="#configuration" class="table-of-contents__link">Configuration</a><ul><li><a href="#ory-oathkeeper-identity-and-access-proxy" class="table-of-contents__link">ORY Oathkeeper: Identity and Access Proxy</a></li><li><a href="#id-token-mutator" class="table-of-contents__link">ID Token Mutator</a></li><li><a href="#error-handling" class="table-of-contents__link">Error Handling</a></li><li><a href="#access-rules" class="table-of-contents__link">Access Rules</a></li></ul></li><li><a href="#cleaning-up-docker" class="table-of-contents__link">Cleaning up Docker</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Company</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.ory.sh/imprint" target="_blank" rel="noopener noreferrer" class="footer__link-item">Imprint</a></li><li class="footer__item"><a href="https://www.ory.sh/privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://www.ory.sh/tos" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li></ul></div></div><div class="text--center"><div>Copyright Â© 2020 ORY GmbH</div></div></div><div id="codefund"></div><script src="https://codefund.io/properties/140/funder.js" async=""></script><script>document.querySelectorAll(".tabs .tabs-nav .nav-item a").forEach((function(t){t.addEventListener("click",(function(e){return e.preventDefault(),t.closest(".tabs-nav").querySelectorAll(".nav-item a").forEach((function(t){t.classList.remove("active")})),t.closest(".tabs").querySelectorAll(".tab-content .tab-pane").forEach((function(t){t.classList.remove("active")})),t.classList.add("active"),document.getElementById(t.href.split("#")[1]).classList.add("active"),!1}))}))</script></footer></div>
<script src="/kratos/docs/styles.47fe7342.js"></script>
<script src="/kratos/docs/runtime~main.25132285.js"></script>
<script src="/kratos/docs/main.ad3de72d.js"></script>
<script src="/kratos/docs/2.3f0cafd9.js"></script>
<script src="/kratos/docs/3.9748f2ba.js"></script>
<script src="/kratos/docs/1be78505.d928f7bc.js"></script>
<script src="/kratos/docs/eb6fb697.9e49424f.js"></script>
<script src="/kratos/docs/255.5a2f44ed.js"></script>
<script src="/kratos/docs/254.7bfb09c2.js"></script>
<script src="/kratos/docs/589d5674.af1ba59e.js"></script>
<script src="/kratos/docs/17896441.b979b995.js"></script>
<script src="/kratos/docs/b700ae95.fcbb9753.js"></script>
</body>
</html>